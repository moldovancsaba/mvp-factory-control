generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum AgentRuntime {
  LOCAL
  CLOUD
  MANUAL
}

enum AgentReadiness {
  NOT_READY
  READY
  PAUSED
}

enum AgentControlRole {
  ALPHA
  BETA
}

enum AlphaContextStatus {
  OPEN
  ACTIVE
  TRANSFERRED
  CLOSED
}

enum AlphaContextPackageSnapshotKind {
  ACTIVATED
  HANDOVER_PACKAGE
  TRANSFER_OUT
  TRANSFER_IN
  CLOSED
}

enum ThreadKind {
  GLOBAL
  ISSUE
  PRODUCT
}

enum MessageAuthorType {
  HUMAN
  AGENT
  SYSTEM
}

enum TaskStatus {
  QUEUED
  RUNNING
  DONE
  FAILED
  CANCELED
  MANUAL_REQUIRED
  DEAD_LETTER
}

// next-auth (Prisma adapter) models
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages ChatMessage[]
  threadsCreated ChatThread[] @relation("ThreadCreatedBy")

  tasksCreated AgentTask[]
  alphaContextWindowsCreated AlphaContextWindow[] @relation("AlphaContextWindowCreatedBy")
  alphaContextPackageInvariantsCreated AlphaContextPackageInvariant[] @relation("AlphaContextPackageInvariantCreatedBy")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// War Room domain models
model Agent {
  id           String      @id @default(cuid())
  key          String      @unique
  displayName  String
  avatarUrl    String?
  runtime      AgentRuntime @default(MANUAL)
  readiness    AgentReadiness @default(NOT_READY)
  controlRole  AgentControlRole @default(BETA)
  model        String?
  host         String?
  enabled      Boolean     @default(true)
  capabilities Json?
  lastHeartbeatAt DateTime?
  lastHeartbeatMeta Json?
  smokeTestPassedAt DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  tasks AgentTask[]
  alphaContextWindows AlphaContextWindow[]
  activeProjectLocks ProjectAlphaLock[] @relation("ProjectAlphaLockOwner")
}

model ChatThread {
  id          String     @id @default(cuid())
  kind        ThreadKind
  ref         String
  title       String?
  createdById String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  createdBy User? @relation("ThreadCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  messages  ChatMessage[]

  tasks AgentTask[]

  @@unique([kind, ref])
}

model ChatMessage {
  id         String            @id @default(cuid())
  threadId   String
  authorType MessageAuthorType
  authorKey  String?
  userId     String?
  content    String
  meta       Json?
  createdAt  DateTime          @default(now())

  thread ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User?      @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([threadId, createdAt])
}

model AgentTask {
  id          String     @id @default(cuid())
  status      TaskStatus @default(QUEUED)
  agentKey    String
  attemptCount Int       @default(0)
  maxAttempts  Int       @default(3)
  nextAttemptAt DateTime @default(now())
  lastFailureCode String?
  lastFailureKind String?
  deadLetteredAt DateTime?
  issueNumber Int?
  threadId    String?
  title       String
  payload     Json?
  createdById String?
  startedAt   DateTime?
  finishedAt  DateTime?
  error       String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  agent     Agent      @relation(fields: [agentKey], references: [key], onDelete: Cascade)
  createdBy User?      @relation(fields: [createdById], references: [id], onDelete: SetNull)
  thread    ChatThread? @relation(fields: [threadId], references: [id], onDelete: SetNull)
  promptPackageInvariant TaskPromptPackageInvariant?

  @@index([agentKey, status, createdAt])
  @@index([status, nextAttemptAt, createdAt])
  @@index([issueNumber])
}

model TaskPromptPackageInvariant {
  id             String   @id @default(cuid())
  taskId         String   @unique
  sourceKind     String
  sourceRef      String?
  issueNumber    Int?
  snapshotHash   String
  promptText     String
  packageBody    String?
  packageSections Json?
  payloadSnapshot Json?
  createdAt      DateTime @default(now())

  task AgentTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([issueNumber, createdAt])
  @@index([sourceKind, createdAt])
  @@index([createdAt])
}

model OrchestratorLease {
  id              String   @id
  ownerId         String?
  ownerHost       String?
  ownerPid        Int?
  ownerAgentKey   String?
  expiresAt       DateTime?
  lastHeartbeatAt DateTime?
  heartbeatCount  Int      @default(0)
  acquiredAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  audits OrchestratorLeaseAudit[]

  @@index([ownerId])
  @@index([expiresAt])
}

model OrchestratorLeaseAudit {
  id              String   @id @default(cuid())
  leaseId         String
  code            String
  message         String
  ownerId         String?
  previousOwnerId String?
  metadata        Json?
  createdAt       DateTime @default(now())

  lease OrchestratorLease @relation(fields: [leaseId], references: [id], onDelete: Cascade)

  @@index([leaseId, createdAt])
  @@index([code, createdAt])
}

model LifecycleAuditEvent {
  id        String   @id @default(cuid())
  entityType String
  entityId   String?
  actorRole  String
  action     String
  fromState  String?
  toState    String?
  allowed    Boolean
  reason     String
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([entityType, entityId, createdAt])
  @@index([actorRole, action, createdAt])
  @@index([createdAt])
}

model InboundEmailEvent {
  id                  String   @id @default(cuid())
  externalMessageId   String?  @unique
  channel             String   @default("email")
  senderEmail         String
  senderName          String?
  subject             String
  bodyText            String
  authorized          Boolean  @default(false)
  authorizationReason String
  status              String
  attemptCount        Int      @default(0)
  maxAttempts         Int      @default(3)
  nextAttemptAt       DateTime?
  lastFailureCode     String?
  lastFailureMessage  String?
  threadId            String?
  taskId              String?
  meta                Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([status, createdAt])
  @@index([senderEmail, createdAt])
  @@index([channel, createdAt])
}

model AlphaContextWindow {
  id                    String             @id @default(cuid())
  projectKey            String
  projectName           String
  ownerAgentKey         String
  status                AlphaContextStatus @default(OPEN)
  activationHandoverRef String?
  transferHandoverRef   String?
  closeHandoverRef      String?
  continuityNote        String?
  contextUsagePercent   Int                @default(0)
  contextUsageUpdatedAt DateTime?
  contextWarningAt      DateTime?
  contextBlockedAt      DateTime?
  handoverPackageRef    String?
  continuationPromptRef String?
  handoverPackageReadyAt DateTime?
  guardrailOverrideUntil DateTime?
  guardrailOverrideReason String?
  predecessorId         String?
  activatedAt           DateTime?
  transferredAt         DateTime?
  closedAt              DateTime?
  createdById           String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt

  ownerAgent Agent @relation(fields: [ownerAgentKey], references: [key], onDelete: Cascade)
  createdBy User? @relation("AlphaContextWindowCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  predecessor AlphaContextWindow? @relation("AlphaContextWindowPredecessor", fields: [predecessorId], references: [id], onDelete: SetNull)
  successors AlphaContextWindow[] @relation("AlphaContextWindowPredecessor")
  lock ProjectAlphaLock?
  auditEvents AlphaContextAuditEvent[]
  packageInvariants AlphaContextPackageInvariant[]

  @@index([projectKey, status, createdAt])
  @@index([ownerAgentKey, status, createdAt])
  @@index([projectName, createdAt])
}

model AlphaContextPackageInvariant {
  id                    String                         @id @default(cuid())
  windowId              String
  projectKey            String
  projectName           String
  snapshotKind          AlphaContextPackageSnapshotKind
  predecessorSnapshotId String?
  sourceRef             String?
  snapshotHash          String
  handoverRef           String?
  handoverPackageRef    String?
  continuationPromptRef String?
  continuityNote        String?
  payloadSnapshot       Json?
  createdById           String?
  createdAt             DateTime                       @default(now())

  window AlphaContextWindow @relation(fields: [windowId], references: [id], onDelete: Cascade)
  predecessor AlphaContextPackageInvariant? @relation("AlphaContextPackageInvariantLineage", fields: [predecessorSnapshotId], references: [id], onDelete: SetNull)
  successors AlphaContextPackageInvariant[] @relation("AlphaContextPackageInvariantLineage")
  createdBy User? @relation("AlphaContextPackageInvariantCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([projectKey, createdAt])
  @@index([windowId, createdAt])
  @@index([snapshotKind, createdAt])
  @@index([predecessorSnapshotId])
}

model ProjectAlphaLock {
  projectKey          String   @id
  projectName         String
  activeWindowId      String?  @unique
  activeOwnerAgentKey String?
  activatedAt         DateTime?
  continuityRef       String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  activeWindow AlphaContextWindow? @relation(fields: [activeWindowId], references: [id], onDelete: SetNull)
  activeOwnerAgent Agent? @relation("ProjectAlphaLockOwner", fields: [activeOwnerAgentKey], references: [key], onDelete: SetNull)

  @@index([activeOwnerAgentKey])
  @@index([projectName])
}

model AlphaContextAuditEvent {
  id                  String   @id @default(cuid())
  projectKey          String
  projectName         String
  actorRole           String
  action              String
  allowed             Boolean
  reason              String
  windowId            String?
  conflictingWindowId String?
  metadata            Json?
  createdAt           DateTime @default(now())

  window AlphaContextWindow? @relation(fields: [windowId], references: [id], onDelete: SetNull)

  @@index([projectKey, createdAt])
  @@index([action, createdAt])
  @@index([windowId, createdAt])
}

model AlphaFailureEvent {
  id              String   @id @default(cuid())
  failureClass    String
  severity        String
  fallbackAction  String
  projectKey      String?
  projectName     String?
  issueNumber     Int?
  taskId          String?
  threadId        String?
  leaseHealth     String?
  contextWindowId String?
  remediation     String
  metadata        Json?
  createdAt       DateTime @default(now())

  @@index([failureClass, createdAt])
  @@index([projectKey, createdAt])
  @@index([issueNumber, createdAt])
  @@index([severity, createdAt])
}
