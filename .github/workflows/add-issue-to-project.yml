# When a new issue is opened in this repo, add it to the MVP Factory Board (Project 1).
# Keeps the board in sync: every issue becomes a card.
# Requires: repo secret MVP_PROJECT_TOKEN (PAT with read:project + project scope). See docs/SYNC.md.

name: Add new issue to project board

on:
  issues:
    types: [opened]

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Get project ID
        id: project
        env:
          TOKEN: ${{ secrets.MVP_PROJECT_TOKEN }}
        run: |
          if [ -z "$TOKEN" ]; then
            echo "::warning::MVP_PROJECT_TOKEN secret not set. Add a PAT with project scope (see docs/SYNC.md)."
            exit 0
          fi
          PROJECT_ID=$(curl -sL -X POST -H "Authorization: bearer $TOKEN" -H "Content-Type: application/json" \
            -d '{"query":"query { user(login: \"moldovancsaba\") { projectV2(number: 1) { id } } }"}' \
            https://api.github.com/graphql | jq -r '.data.user.projectV2.id')
          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" = "null" ]; then
            echo "::warning::Could not get project ID. Check token has read:project scope."
            exit 0
          fi
          echo "id=$PROJECT_ID" >> $GITHUB_OUTPUT

      - name: Add issue to project
        if: steps.project.outputs.id != ''
        env:
          TOKEN: ${{ secrets.MVP_PROJECT_TOKEN }}
          PROJECT_ID: ${{ steps.project.outputs.id }}
          ISSUE_NODE_ID: ${{ github.event.issue.node_id }}
        run: |
          curl -sL -X POST -H "Authorization: bearer $TOKEN" -H "Content-Type: application/json" \
            -d "{\"query\":\"mutation { addProjectV2ItemById(input: { projectId: \\\"$PROJECT_ID\\\", contentId: \\\"$ISSUE_NODE_ID\\\" }) { item { id } } }\"}" \
            https://api.github.com/graphql
          echo "Issue added to board: https://github.com/users/moldovancsaba/projects/1"
